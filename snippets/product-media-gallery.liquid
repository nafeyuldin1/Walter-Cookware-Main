{% comment %}
  Renders a product media gallery.
  File: snippets/product-media-gallery.liquid
{% endcomment %}

{%- liquid
  assign media_count = product.media.size
  if section.settings.hide_variants and variant_images.size > 0
    assign media_count = media_count | minus: variant_images.size | plus: 1
  endif

  if section.settings.media_size == 'large'
    assign media_width = 0.65
  elsif section.settings.media_size == 'medium'
    assign media_width = 0.55
  elsif section.settings.media_size == 'small'
    assign media_width = 0.45
  endif
-%}

<style>
  /* === LAYOUT ENGINE === */
  media-gallery {
    display: block;
    position: relative;
  }

  /* Desktop: Side-by-Side Layout */
  @media screen and (min-width: 990px) {
    media-gallery {
      display: flex !important;
      flex-direction: row !important;
      align-items: flex-start;
      gap: 20px;
    }

    /* Left Column: Thumbnails */
    .thumbnails-wrapper {
      width: 100px;
      flex-shrink: 0;
      order: 1; /* Force Left */
      position: sticky;
      top: 20px;
    }

    .thumbnail-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .thumbnail-list__item {
      width: 100%;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 4px;
      transition: border-color 0.2s;
    }

    .thumbnail-list__item.is-active {
      border-color: #000; /* Active Border Color */
    }

    .thumbnail-list__item img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 2px;
      object-fit: cover;
      aspect-ratio: 1/1;
    }

    /* Right Column: Main Viewer */
    .viewer-wrapper {
      flex: 1;
      width: calc(100% - 120px);
      order: 2; /* Force Right */
      overflow: hidden; /* Important for scroll */
    }

    .product__media-list {
      display: flex;
      width: 100%;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    
    /* Hide Scrollbar */
    .product__media-list::-webkit-scrollbar { display: none; }
    .product__media-list { -ms-overflow-style: none; scrollbar-width: none; }

    .product__media-item {
      min-width: 100%;
      width: 100%;
      scroll-snap-align: start;
      position: relative;
    }
  }

  /* Mobile: Standard Stack/Slider */
  @media screen and (max-width: 989px) {
    .thumbnails-wrapper { display: none; } /* Hide thumbs on mobile if desired, or change logic */
    .viewer-wrapper { width: 100%; }
    .product__media-list {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
    }
    .product__media-item {
      min-width: 100%;
      scroll-snap-align: center;
    }
  }
</style>

<media-gallery id="MediaGallery-{{ section.id }}" role="region" data-desktop-layout="thumbnail_slider">
  <div id="GalleryStatus-{{ section.id }}" class="visually-hidden" role="status"></div>

  {%- if media_count > 1 -%}
    <div class="thumbnails-wrapper small-hide">
      <ul class="thumbnail-list" id="ThumbList-{{ section.id }}">
        {%- if product.selected_or_first_available_variant.featured_media != null -%}
          {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
          <li class="thumbnail-list__item is-active" data-target="{{ section.id }}-{{ featured_media.id }}">
            <img src="{{ featured_media.preview_image | image_url: width: 200 }}" alt="{{ featured_media.alt | escape }}" loading="lazy">
          </li>
        {%- endif -%}
        
        {%- for media in product.media -%}
          {%- unless media.id == product.selected_or_first_available_variant.featured_media.id -%}
            <li class="thumbnail-list__item" data-target="{{ section.id }}-{{ media.id }}">
              <img src="{{ media.preview_image | image_url: width: 200 }}" alt="{{ media.alt | escape }}" loading="lazy">
            </li>
          {%- endunless -%}
        {%- endfor -%}
      </ul>
    </div>
  {%- endif -%}

  <div class="viewer-wrapper">
    <ul id="Slider-Gallery-{{ section.id }}" class="product__media-list">
      {%- if product.selected_or_first_available_variant.featured_media != null -%}
        {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
        <li id="Slide-{{ section.id }}-{{ featured_media.id }}" class="product__media-item is-active" data-media-id="{{ featured_media.id }}">
           {% render 'product-thumbnail', media: featured_media, modal_id: section.id, position: 'featured', loop: section.settings.enable_video_looping, xr_button: true %}
        </li>
      {%- endif -%}
      
      {%- for media in product.media -%}
        {%- unless media.id == product.selected_or_first_available_variant.featured_media.id -%}
          <li id="Slide-{{ section.id }}-{{ media.id }}" class="product__media-item" data-media-id="{{ media.id }}">
            {% render 'product-thumbnail', media: media, modal_id: section.id, position: forloop.index, loop: section.settings.enable_video_looping, xr_button: true %}
          </li>
        {%- endunless -%}
      {%- endfor -%}
    </ul>
    
    <div class="slider-buttons medium-hide large-up-hide" style="display:flex; justify-content:center; gap:20px; margin-top:10px;">
       <button onclick="mobileScroll('prev')" style="padding:10px;">←</button>
       <button onclick="mobileScroll('next')" style="padding:10px;">→</button>
    </div>
  </div>

</media-gallery>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const sectionId = "{{ section.id }}";
  const mainSlider = document.getElementById(`Slider-Gallery-${sectionId}`);
  const thumbItems = document.querySelectorAll(`#ThumbList-${sectionId} .thumbnail-list__item`);

  // --- CORE FUNCTION: Change Image ---
  window.goToMedia = function(mediaId) {
    if (!mediaId || !mainSlider) return;

    // 1. Find the target slide
    const targetSlideId = `Slide-${sectionId}-${mediaId}`;
    const targetSlide = document.getElementById(targetSlideId);

    if (targetSlide) {
      // Scroll Main Slider
      mainSlider.scrollTo({
        left: targetSlide.offsetLeft,
        behavior: 'smooth'
      });

      // Update Active Thumbnail Class
      thumbItems.forEach(t => t.classList.remove('is-active'));
      const activeThumb = document.querySelector(`.thumbnail-list__item[data-target="${sectionId}-${mediaId}"]`);
      if (activeThumb) activeThumb.classList.add('is-active');
    }
  };

  // --- Add Click Events to Custom Thumbnails ---
  thumbItems.forEach(item => {
    item.addEventListener('click', function() {
      // Extract Media ID from "sectionId-MediaID"
      const rawTarget = this.getAttribute('data-target');
      const mediaId = rawTarget.replace(`${sectionId}-`, '');
      window.goToMedia(mediaId);
    });
  });

  // Mobile Arrows Helper
  window.mobileScroll = function(direction) {
    if(!mainSlider) return;
    const width = mainSlider.offsetWidth;
    mainSlider.scrollBy({ left: direction === 'next' ? width : -width, behavior: 'smooth' });
  }
});
</script>