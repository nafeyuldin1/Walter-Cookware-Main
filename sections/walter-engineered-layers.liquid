{% comment %}
  Engineered Exploded View Section
  Fully Dynamic - Mobile & Desktop Responsive
  Fixed Desktop Positioning
{% endcomment %}

{%- style -%}
  #ieo-{{ section.id }} {
    --bg-color: {{ section.settings.bg_color }};
    --title-color: {{ section.settings.title_color }};
    --line-color: {{ section.settings.line_color }};
    --item-title-color: {{ section.settings.item_title_color }};
    --item-desc-color: {{ section.settings.item_desc_color }};
    --st: {{ section.settings.anim_speed }}ms;
    
    /* Desktop Layout Variables */
    --desk-height: {{ section.settings.desktop_height }}px;
    --desk-img-width: {{ section.settings.desktop_img_width }}%;
    --desk-img-pos-x: {{ section.settings.desktop_img_pos_x }}px;
    
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }
  
  /* Mobile Padding override */
  @media (max-width: 749px) {
    #ieo-{{ section.id }} {
      padding-top: {{ section.settings.padding_top | divided_by: 1.5 }}px;
      padding-bottom: {{ section.settings.padding_bottom | divided_by: 1.5 }}px;
    }
  }
{%- endstyle -%}

<section id="ieo-{{ section.id }}" class="ieo" style="background: var(--bg-color);">
  <div class="ieo-inner">
    
    {% if section.settings.heading != blank %}
      <h2 class="ieo-title">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="ieo-layout">
      
      <div class="ieo-visual">
        {% for block in section.blocks %}
          {% assign i = forloop.index0 %}
          {% assign step = forloop.index %}
          {% assign z_index = 1000 | minus: i %}
          
          {% if block.settings.image != blank %}
            <img 
              class="ieo-layer {% if forloop.first %}ieo-pan{% endif %} from-left" 
              style="--off: {{ block.settings.offset_y }}px; --i: {{ i }}; z-index: {{ z_index }};" 
              data-step="{{ step }}" 
              src="{{ block.settings.image | image_url: width: 1600 }}" 
              alt="{{ block.settings.image.alt | escape }}" 
              loading="lazy"
              width="{{ block.settings.image.width }}"
              height="{{ block.settings.image.height }}"
            >
          {% else %}
            {{ 'image' | placeholder_svg_tag: 'ieo-layer placeholder-svg' }}
          {% endif %}
        {% endfor %}
      </div>

      <div class="ieo-right">
        <ul class="ieo-list">
          {% for block in section.blocks %}
            {% assign i = forloop.index0 %}
            {% assign step = forloop.index %}
            
            <li class="ieo-li" data-step="{{ step }}" style="--i: {{ i }};" {{ block.shopify_attributes }}>
              <span class="ieo-line"></span>
              <div class="ieo-text">
                {% if block.settings.title != blank %}
                  <div class="ieo-li-title">{{ block.settings.title }}</div>
                {% endif %}
                
                {% if block.settings.description != blank %}
                  <div class="ieo-li-desc">{{ block.settings.description }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>

    </div>
  </div>
</section>

<style>
/* CSS Scoped to Section ID */
#ieo-{{ section.id }} .ieo-inner {
  max-width: 1400px;
  margin: 0 auto;
  padding-left: 24px;
  padding-right: 24px;
  overflow: hidden; /* Prevents horizontal scroll */
}

#ieo-{{ section.id }} .ieo-title {
  margin: 0 0 64px;
  font-family: 'Neue Montreal', sans-serif; 
  color: var(--title-color);
  font-size: {{ section.settings.heading_size }}px;
  font-weight: 400;
  line-height: 130%;
  letter-spacing: 1.92px;
  text-transform: capitalize;
  text-align: center;
}

/* DESKTOP LAYOUT */
#ieo-{{ section.id }} .ieo-layout {
  display: grid;
  grid-template-columns: 1fr 1fr; /* Equal split */
  gap: 48px;
  align-items: center;
  position: relative;
}

/* Visual stack Container */
#ieo-{{ section.id }} .ieo-visual {
  position: relative;
  height: var(--desk-height); /* Dynamic Height */
  width: 100%;
  display: flex;
  justify-content: flex-end; /* Align images towards the text */
}

#ieo-{{ section.id }} .ieo-layer {
  position: absolute;
  /* Dynamic Positioning controlled by Schema */
  right: 0; 
  left: auto;
  margin-right: var(--desk-img-pos-x); /* Adjustable horizontal spacing */
  
  top: 50px; /* Base top spacing */
  width: var(--desk-img-width); /* Dynamic Width */
  max-width: 600px;
  height: auto;
  display: block;
  
  opacity: 0;
  transform: translateY(var(--off, 0px)) scale(.98);
  transition: transform .7s ease, opacity .7s ease;
  will-change: transform, opacity;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); /* Better shadow */
  transition-delay: calc(var(--i) * 2 * var(--st));
}

#ieo-{{ section.id }} .ieo-pan { 
  top: -80px; /* Slight lift for the top pan */
} 

/* Animations */
#ieo-{{ section.id }} .ieo-layer.from-left { 
  transform: translateX(-20vw) translateY(var(--off, 0px)) scale(.96); 
}
#ieo-{{ section.id }} .ieo-layer.is-on { 
  opacity: 1; 
  transform: translateX(0) translateY(var(--off, 0px)) scale(1); 
}

/* Right list */
#ieo-{{ section.id }} .ieo-right { 
  margin-right: auto;
  padding-left: 20px; 
}
#ieo-{{ section.id }} .ieo-list { 
  list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 46px; 
}

#ieo-{{ section.id }} .ieo-li {
  display: flex;
  align-items: center;
  gap: 16px;
  opacity: 0;
  transform: translateX(-50px);
  transition: transform .7s ease, opacity .7s ease;
  will-change: transform, opacity;
  transition-delay: calc(var(--i) * 2 * var(--st));
  visibility: hidden;
  pointer-events: none;
}

#ieo-{{ section.id }} .ieo-li.is-on {
  opacity: 1;
  transform: translateX(0);
  visibility: visible;
  pointer-events: auto;
}

#ieo-{{ section.id }} .ieo-line {
  background: var(--line-color);
  height: 2px;
  width: 100px; /* Fixed width line */
  flex-shrink: 0;
}

#ieo-{{ section.id }} .ieo-text { max-width: 520px; }

#ieo-{{ section.id }} .ieo-li-title {
  color: var(--item-title-color);
  font-size: 24px;
  font-weight: 500;
  line-height: 140%;
  letter-spacing: 0.48px;
  text-transform: capitalize;
}

#ieo-{{ section.id }} .ieo-li-desc {
  margin-top: 10px;
  color: var(--item-desc-color);
  font-size: 16px;
  font-weight: 400;
  line-height: 150%;
  letter-spacing: 0.64px;
}

/* === Responsive Media Queries === */

/* Mobile (Untouched/Fixed) */
@media (max-width: 749px) {
  #ieo-{{ section.id }} .ieo-layout { grid-template-columns: 1fr 180px; gap: 0; }
  
  #ieo-{{ section.id }} .ieo-visual {
    height: 600px;
    width: auto;
    justify-content: flex-start;
  }
  
  #ieo-{{ section.id }} .ieo-layer {
    width: 280px; /* Fixed width for mobile consistency */
    left: -120px; /* Pull image left */
    right: auto;
    top: 50px;
    opacity: 0;
    transform: translateX(-40vw) translateY(calc(var(--i) * 90px)) scale(.96);
    margin-right: 0;
  }
  
  #ieo-{{ section.id }} .ieo-pan { 
    width: 280px; 
    left: -120px; 
    top: 40px; 
  }
  
  #ieo-{{ section.id }} .ieo-layer.is-on {
    opacity: 1 !important;
    transform: translateX(0) translateY(calc(var(--i) * 90px)) scale(1) !important;
  }
  
  #ieo-{{ section.id }} .ieo-list { gap: 20px; }
  
  #ieo-{{ section.id }} .ieo-title { 
    font-size: 28px; 
    margin-bottom: 50px; 
  }
  
  #ieo-{{ section.id }} .ieo-li-title { font-size: 14px; letter-spacing: .28px; }
  #ieo-{{ section.id }} .ieo-li-desc { font-size: 12px; margin-top: 4px; }

  #ieo-{{ section.id }} .ieo-li {
    opacity: 0;
    transform: translateX(-20px);
    transition-delay: 0s !important; 
    visibility: visible;
    pointer-events: auto;
  }
  
  #ieo-{{ section.id }} .ieo-li.is-on {
    opacity: 1;
    transform: translateX(0);
  }
  
  #ieo-{{ section.id }} .ieo-line { width: 30px; }
}

/* Ultra-Wide Adjustment */
@media (min-width: 1800px) {
  #ieo-{{ section.id }} .ieo-inner { max-width: 1600px; }
  #ieo-{{ section.id }} .ieo-layer { max-width: 800px; }
}
</style>

<script>
(() => {
  const sectionId = "ieo-{{ section.id }}";
  const sec = document.getElementById(sectionId);
  if (!sec) return;

  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const layers = Array.from(sec.querySelectorAll('.ieo-layer'));
  const listItems = Array.from(sec.querySelectorAll('.ieo-li[data-step]'));
  const itemsByStep = new Map(listItems.map(el => [ Number(el.getAttribute('data-step')), el ]));
  const layersByStep = new Map(layers.map(el => [ Number(el.getAttribute('data-step')), el ]));

  if (prefersReduced) {
    layers.forEach(el => el.classList.add('is-on'));
    listItems.forEach(el => el.classList.add('is-on'));
    return;
  }

  const io = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;
      const step = Number(entry.target.getAttribute('data-step'));
      const layer = layersByStep.get(step);
      const li = itemsByStep.get(step);
      
      if (layer) layer.classList.add('is-on');
      if (li) li.classList.add('is-on');
      
      io.unobserve(entry.target);
    });
  }, { root: null, rootMargin: '-10% 0% -10% 0%', threshold: 0 });

  listItems.forEach(el => io.observe(el));

  document.addEventListener('shopify:section:load', (e) => {
    if (!sec.contains(e.target)) return;
    io.disconnect();
    const freshItems = Array.from(sec.querySelectorAll('.ieo-li[data-step]'));
    freshItems.forEach(el => io.observe(el));
  });
})();
</script>

{% schema %}
{
  "name": "Engineered View Layers",
  "settings": [
    {
      "type": "header",
      "content": "Desktop Layout Adjustments"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "min": 500,
      "max": 1200,
      "step": 20,
      "unit": "px",
      "label": "Visual Container Height",
      "info": "Adjust this if images are cut off vertically.",
      "default": 800
    },
    {
      "type": "range",
      "id": "desktop_img_width",
      "min": 40,
      "max": 120,
      "step": 5,
      "unit": "%",
      "label": "Image Size (Scale)",
      "default": 80
    },
    {
      "type": "range",
      "id": "desktop_img_pos_x",
      "min": -200,
      "max": 200,
      "step": 10,
      "unit": "px",
      "label": "Image Horizontal Position",
      "info": "Positive moves Left (towards center), Negative moves Right (away from text).",
      "default": 0
    },
    {
      "type": "header",
      "content": "Color Settings"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#07231b"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Heading Color",
      "default": "#BCA588"
    },
    {
      "type": "color",
      "id": "line_color",
      "label": "Connector Line Color",
      "default": "#A3835F"
    },
    {
      "type": "color",
      "id": "item_title_color",
      "label": "List Title Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "item_desc_color",
      "label": "List Description Color",
      "default": "#B0B0B0"
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Main Heading",
      "default": "Engineered From The Inside Out"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 20,
      "max": 80,
      "step": 1,
      "unit": "px",
      "label": "Heading Font Size (Desktop)",
      "default": 48
    },
    {
      "type": "header",
      "content": "Animation Settings"
    },
    {
      "type": "range",
      "id": "anim_speed",
      "min": 100,
      "max": 500,
      "step": 10,
      "unit": "ms",
      "label": "Animation Speed (Delay)",
      "default": 220
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "layer",
      "name": "Layer",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Layer Image"
        },
        {
          "type": "header",
          "content": "Positioning"
        },
        {
          "type": "number",
          "id": "offset_y",
          "label": "Desktop Vertical Offset (px)",
          "info": "How far down this layer sits. E.g., 0, 100, 200.",
          "default": 0
        },
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Layer Material"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Description",
          "default": "Benefit of this layer"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Engineered View Layers",
      "blocks": [
        {
          "type": "layer",
          "settings": {
            "title": "Pure Titanium",
            "description": "Non-toxic. Non-stick.",
            "offset_y": 0
          }
        },
        {
          "type": "layer",
          "settings": {
            "title": "Aluminum Core",
            "description": "Internal Heat",
            "offset_y": 120
          }
        }
      ]
    }
  ]
}
{% endschema %}