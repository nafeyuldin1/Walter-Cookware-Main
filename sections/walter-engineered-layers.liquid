{% schema %}
{
  "name": "Engineered Layers",
  "settings": [
    {
      "type": "header",
      "content": "Section Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#07231b"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#BCA588"
    },
    {
      "type": "color",
      "id": "line_color",
      "label": "Line Color",
      "default": "#A3835F"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Layer Title Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "desc_color",
      "label": "Layer Description Color",
      "default": "#B0B0B0"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Engineered From The Inside Out"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 2,
      "unit": "px",
      "label": "Padding Top",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 2,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "layer",
      "name": "Layer",
      "limit": 6,
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Layer Image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Layer Name"
        },
        {
          "type": "text",
          "id": "desc",
          "label": "Description",
          "default": "Layer details here"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Engineered Layers",
      "blocks": [
        {
          "type": "layer",
          "settings": {
            "title": "Pure Titanium With SlipScale Technology",
            "desc": "Non-toxic. Non-stick."
          }
        },
        {
          "type": "layer",
          "settings": {
            "title": "Third Recycled Aluminum Core",
            "desc": "Pushes heat out evenly to all edges"
          }
        },
        {
          "type": "layer",
          "settings": {
            "title": "Second Recycled Aluminum Core",
            "desc": "Stabilizes internal heat"
          }
        },
        {
          "type": "layer",
          "settings": {
            "title": "First Recycled Aluminum Core",
            "desc": "Pulls heat in fast"
          }
        },
        {
          "type": "layer",
          "settings": {
            "title": "Induction-Ready Stainless Steel",
            "desc": "Adds durability & magnetic conductivity"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<section id="ieo-template--{{ section.id }}" class="ieo" style="--st: 220ms;">
  <div class="ieo-inner">
    {% if section.settings.heading != blank %}
      <h2 class="ieo-title">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="ieo-layout">
      
      <div class="ieo-visual">
        {% for block in section.blocks %}
          
          {% comment %} 
            Logic for Offsets:
            Index 0 (Pan) = 0px
            Index 1 (1st Layer) = 0px
            Index 2 (2nd Layer) = 120px
            Index 3 (3rd Layer) = 240px
            ...etc
          {% endcomment %}

          {% assign offset_val = 0 %}
          {% if forloop.index0 > 1 %}
            {% assign multiplier = forloop.index0 | minus: 1 %}
            {% assign offset_val = multiplier | times: 120 %}
          {% endif %}

          {% assign z_index = 1000 | minus: forloop.index0 %}
          
          {% assign layer_class = 'ieo-layer from-left' %}
          {% if forloop.first %}
            {% assign layer_class = layer_class | append: ' ieo-pan' %}
          {% endif %}

          {% if block.settings.image != blank %}
            {{ block.settings.image | image_url: width: 1200 | image_tag: 
              class: layer_class,
              loading: 'lazy',
              data-step: forloop.index,
              style: "--off: " | append: offset_val | append: "px; --i: " | append: forloop.index0 | append: "; z-index: " | append: z_index | append: ";" 
            }}
          {% else %}
             <div class="{{ layer_class }} placeholder-layer" 
                  data-step="{{ forloop.index }}"
                  style="--off: {{ offset_val }}px; --i: {{ forloop.index0 }}; z-index: {{ z_index }}; background: #4a4a4a; width: 100%; height: 50px; border-radius: 50%;">
             </div>
          {% endif %}

        {% endfor %}
      </div>

      <div class="ieo-right">
        <ul class="ieo-list">
          {% for block in section.blocks %}
            <li class="ieo-li" data-step="{{ forloop.index }}" style="--i: {{ forloop.index0 }};" {{ block.shopify_attributes }}>
              <span class="ieo-line"></span>
              <div class="ieo-text">
                {% if block.settings.title != blank %}
                  <div class="ieo-li-title">{{ block.settings.title }}</div>
                {% endif %}
                
                {% if block.settings.desc != blank %}
                  <div class="ieo-li-desc">{{ block.settings.desc }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>

    </div>
  </div>
</section>

<style>
  /* Scoped Variables */
  #ieo-template--{{ section.id }} {
    background-color: {{ section.settings.bg_color }};
    --heading-color: {{ section.settings.heading_color }};
    --line-color: {{ section.settings.line_color }};
    --title-color: {{ section.settings.title_color }};
    --desc-color: {{ section.settings.desc_color }};
    --pt: {{ section.settings.padding_top }}px;
    --pb: {{ section.settings.padding_bottom }}px;
  }

  #ieo-template--{{ section.id }}.ieo {
    color: #fff;
  }

  #ieo-template--{{ section.id }} .ieo-inner {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--pt) 24px var(--pb) 24px;
  }

  #ieo-template--{{ section.id }} .ieo-title {
    margin: 0 0 64px;
    font-family: 'Neue Montreal', sans-serif;
    color: var(--heading-color);
    font-size: 48px;
    font-style: normal;
    font-weight: 400;
    line-height: 130%;
    letter-spacing: 1.92px;
    text-transform: capitalize;
    text-align: center;
  }

  #ieo-template--{{ section.id }} .ieo-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 48px;
    align-items: center;
  }

  /* Visual stack */
  #ieo-template--{{ section.id }} .ieo-visual {
    position: relative;
    height: 930px;
    margin-left: auto;
    width: min(600px, 44vw);
    aspect-ratio: 1/1;
  }

  #ieo-template--{{ section.id }} .ieo-layer {
    position: absolute;
    left: 100px;
    top: 20px;
    right: auto;
    margin: 0 auto;
    max-width: 100%;
    height: auto;
    display: block;
    opacity: 0;
    transform: translateY(var(--off, 0px)) scale(.98);
    transition: transform .7s ease, opacity .7s ease;
    will-change: transform, opacity;
    filter: drop-shadow(0 2px 10px rgba(0, 0, 0, .25));
    transition-delay: calc(var(--i) * 2 * var(--st));
  }

  /* Target the first image (Pan) specifically */
  #ieo-template--{{ section.id }} .ieo-layer.ieo-pan {
    top: -100px;
  }
  
  /* Placeholder style fix */
  #ieo-template--{{ section.id }} .placeholder-layer {
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }

  #ieo-template--{{ section.id }} .ieo-layer.from-left {
    transform: translateX(-40vw) translateY(var(--off, 0px)) scale(.96);
  }

  #ieo-template--{{ section.id }} .ieo-layer.is-on {
    opacity: 1;
    transform: translateX(0) translateY(var(--off, 0px)) scale(1);
  }

  /* Right list */
  #ieo-template--{{ section.id }} .ieo-right {
    margin-right: auto;
  }

  #ieo-template--{{ section.id }} .ieo-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 46px;
  }

  #ieo-template--{{ section.id }} .ieo-li {
    display: flex;
    align-items: center;
    gap: 16px;
    opacity: 0;
    transform: translateX(-40vw) translateY(8px);
    /* from left */
    transition: transform .7s ease, opacity .7s ease;
    /* match image timing */
    will-change: transform, opacity;
    transition-delay: calc(var(--i) * 2 * var(--st));
    /* same stagger as images */
    visibility: hidden;
    pointer-events: none;
  }

  #ieo-template--{{ section.id }} .ieo-li.is-on {
    opacity: 1;
    transform: translateX(0) translateY(0);
    visibility: visible;
    pointer-events: auto;
  }

  #ieo-template--{{ section.id }} .ieo-line {
    background: var(--line-color);
    height: 2px;
    flex: 0 0 157px;
    position: relative;
  }

  #ieo-template--{{ section.id }} .ieo-text {
    max-width: 520px;
  }

  #ieo-template--{{ section.id }} .ieo-li-title {
    font-family: 'Neue Montreal', sans-serif;
    color: var(--title-color);
    font-size: 24px;
    font-style: normal;
    font-weight: 500;
    line-height: 140%;
    letter-spacing: 0.48px;
    text-transform: capitalize;
  }

  #ieo-template--{{ section.id }} .ieo-li-desc {
    margin-top: 16px;
    font-family: 'Neue Montreal', sans-serif;
    color: var(--desc-color);
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 150%;
    letter-spacing: 0.64px;
  }

  /* Mobile */
  @media (max-width: 749px) {
    #ieo-template--{{ section.id }} .ieo-layout {
      grid-template-columns: 1fr 202px;
      gap: 0;
    }

    #ieo-template--{{ section.id }} .ieo-visual {
      max-width: auto;
      aspect-ratio: auto;
      height: 600px;
      width: 157px;
    }

    #ieo-template--{{ section.id }} .ieo-layer {
      max-width: none;
      width: 334px;
      left: -91px;
      top: -101px;
      opacity: 0;
      transform: translateX(-40vw) translateY(calc(var(--i) * 101px)) scale(.96);
      transition: transform .7s ease, opacity .7s ease;
    }

    /* Target Pan on Mobile */
    #ieo-template--{{ section.id }} .ieo-layer.ieo-pan {
      width: 334px;
      left: -91px;
      top: -108px;
      max-width: none;
    }

    #ieo-template--{{ section.id }} .ieo-layer.is-on {
      opacity: 1 !important;
      transform: translateX(0) translateY(calc(var(--i) * 101px)) scale(1) !important;
    }

    #ieo-template--{{ section.id }} .ieo-list {
      gap: 20px;
    }

    #ieo-template--{{ section.id }} .ieo-title {
      font-size: 24px;
      letter-spacing: 0.26px;
      margin-bottom: 80px;
    }

    #ieo-template--{{ section.id }} .ieo-li-title {
      font-size: 14px;
      letter-spacing: .28px;
    }

    #ieo-template--{{ section.id }} .ieo-li-desc {
      font-size: 14px;
      letter-spacing: .16px;
      margin-top: 8px;
    }

    #ieo-template--{{ section.id }} .ieo-li {
      opacity: 0;
      transform: translateX(-40vw) translateY(8px);
      transition: transform .7s ease, opacity .7s ease;
      visibility: visible;
      /* keep clickable */
      pointer-events: auto;
      transition-delay: 0s !important;
    }

    #ieo-template--{{ section.id }} .ieo-li.is-on {
      opacity: 1;
      transform: translateX(0) translateY(0);
    }

    #ieo-template--{{ section.id }} .ieo-line {
      flex: 0 0 40px;
    }

    #ieo-template--{{ section.id }} .ieo-inner {
      padding: 64px 16px;
    }

    #ieo-template--{{ section.id }} .ieo-text {
      max-width: 145px;
    }
  }

  /* ===== +30% on ultra-wide (≥2200px) ===== */
  @media (min-width: 2200px) {
    #ieo-template--{{ section.id }} .ieo-inner {
      max-width: 1820px;
      padding: 62.4px 31.2px;
    }

    #ieo-template--{{ section.id }} .ieo-title {
      font-size: 41.6px;
      margin-bottom: 41.6px;
    }

    #ieo-template--{{ section.id }} .ieo-layout {
      gap: 62.4px;
    }

    #ieo-template--{{ section.id }} .ieo-visual {
      height: 1209px;
      width: min(780px, 44vw);
    }

    #ieo-template--{{ section.id }} .ieo-layer {
      left: 130px;
      top: 26px;
    }

    #ieo-template--{{ section.id }} .ieo-layer.ieo-pan {
      top: -130px;
    }

    #ieo-template--{{ section.id }} .ieo-list {
      gap: 59.8px;
    }

    #ieo-template--{{ section.id }} .ieo-li {
      gap: 20.8px;
      transform: translateX(-40vw) translateY(10.4px);
    }

    #ieo-template--{{ section.id }} .ieo-line {
      height: 2.6px;
      flex: 0 0 204.1px;
    }

    #ieo-template--{{ section.id }} .ieo-text {
      max-width: 676px;
    }

    #ieo-template--{{ section.id }} .ieo-li-title {
      font-size: 31.2px;
      letter-spacing: 0.624px;
    }

    #ieo-template--{{ section.id }} .ieo-li-desc {
      margin-top: 20.8px;
      font-size: 20.8px;
      letter-spacing: 0.832px;
    }
  }

  /* ===== −10% on md/desktop (750–1799px) ===== */
  @media (min-width:750px) and (max-width:1799px) {
    #ieo-template--{{ section.id }} .ieo-inner {
      max-width: 1260px;
      padding: 43.2px 21.6px;
    }

    #ieo-template--{{ section.id }} .ieo-title {
      font-size: 43.2px;
      margin-bottom: 28.8px;
    }

    #ieo-template--{{ section.id }} .ieo-layout {
      gap: 43.2px;
    }

    #ieo-template--{{ section.id }} .ieo-visual {
      height: 837px;
      width: min(540px, 44vw);
    }

    #ieo-template--{{ section.id }} .ieo-layer {
      left: 90px;
      top: 18px;
    }

    #ieo-template--{{ section.id }} .ieo-layer.ieo-pan {
      top: -90px;
    }

    #ieo-template--{{ section.id }} .ieo-list {
      gap: 41.4px;
    }

    #ieo-template--{{ section.id }} .ieo-li {
      gap: 14.4px;
      transform: translateX(-40vw) translateY(7.2px);
    }

    #ieo-template--{{ section.id }} .ieo-line {
      height: 1.8px;
      flex: 0 0 141.3px;
    }

    #ieo-template--{{ section.id }} .ieo-text {
      max-width: 468px;
    }

    #ieo-template--{{ section.id }} .ieo-li-title {
      font-size: 21.6px;
      letter-spacing: 0.432px;
    }

    #ieo-template--{{ section.id }} .ieo-li-desc {
      margin-top: 14.4px;
      font-size: 14.4px;
      letter-spacing: 0.576px;
    }
  }

  @media (min-width:399px) and (max-width:500px) {
    #ieo-template--{{ section.id }} .ieo-right {
      margin-left: -13px;
    }

    #ieo-template--{{ section.id }} .ieo-visual {
      margin-left: 0;
    }
  }
</style>

<script>
  (() => {
    const sec = document.getElementById('ieo-template--{{ section.id }}');
    if (!sec) return;

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Dynamically query elements within this specific section
    const layers = Array.from(sec.querySelectorAll('.ieo-layer'));
    const layersByStep = new Map(layers.map(el => [Number(el.getAttribute('data-step')), el]));

    const listItems = Array.from(sec.querySelectorAll('.ieo-li[data-step]'));
    const itemsByStep = new Map(listItems.map(el => [Number(el.getAttribute('data-step')), el]));

    if (prefersReduced) {
      layers.forEach(el => el.classList.add('is-on'));
      listItems.forEach(el => el.classList.add('is-on'));
      return;
    }

    const io = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const step = Number(entry.target.getAttribute('data-step'));
        const layer = layersByStep.get(step);
        const li = itemsByStep.get(step);
        if (layer) layer.classList.add('is-on');
        if (li) li.classList.add('is-on');
        io.unobserve(entry.target);
      });
    }, {
      root: null,
      rootMargin: '-10% 0% -10% 0%',
      threshold: 0
    });

    listItems.forEach(el => io.observe(el));

    // Handle Shopify Theme Editor events to re-initialize if needed
    document.addEventListener('shopify:section:load', (e) => {
      if (!sec.contains(e.target)) return;
      io.disconnect();
      const freshItems = Array.from(sec.querySelectorAll('.ieo-li[data-step]'));
      freshItems.forEach(el => io.observe(el));
    });
  })();
</script>