{% comment %} 
  COMBINED CODE: User Schema + Competitor Styling & Features 
  Fixed: Cart Drawer AJAX trigger, Dark Mode, Missing Blocks
{% endcomment %}

<section id="MainProduct-{{ section.id }}" class="section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}" data-section="{{ section.id }}">
  
  {{ 'section-main-product.css' | asset_url | stylesheet_tag }}
  {{ 'component-accordion.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  {{ 'component-slider.css' | asset_url | stylesheet_tag }}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-loading-spinner.css' | asset_url | stylesheet_tag }}

  {%- style -%}
  /* --- DARK MODE & COMPETITOR STYLES --- */
    .section-{{ section.id }}-padding {
      background: #121212 !important; /* Dark Background */
      color: #ffffff !important;
    }
    .product__title h1 { color: #ffffff !important; font-weight: 400; font-size: 32px; letter-spacing: 1px; }
    .product__text, .price-item, .product__description { color: #B0B0B0 !important; }
    .price-item--sale { color: #E9E2D8 !important; }
    
    /* Benefits Grid (Icons) */
    .benefits-grid { margin: 15px 0; border-top: 1px solid #333; padding-top: 15px; }
    .benefits-grid__list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .benefits-grid__item { display: flex; align-items: center; gap: 8px; }
    .benefits-grid__text { font-size: 12px; line-height: 1.3; color: #b0b0b0; }
    .benefits-grid__text strong { color: #fff; }

    /* Shipping Promise Bar */
    .shipbar { margin: 20px 0; background: #03231A; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px; }
    .shipbar__text { font-size: 13px; color: #D2F1E3; font-weight: 500; }

    /* Custom Info Tabs */
    .pit-container { margin-top: 30px; border-top: 1px solid #454545; }
    .pit-tabs { display: flex; border-bottom: 1px solid #454545; margin-bottom: 15px; }
    .pit-tab { flex: 1; padding: 15px; background: transparent; border: none; color: #B0B0B0; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; }
    .pit-tab.is-active { color: #fff; border-bottom-color: #fff; }
    .pit-panel { display: none; color: #B0B0B0; font-size: 14px; line-height: 1.6; }
    .pit-panel.is-active { display: block; animation: fadeIn 0.5s; }
    .pit-panel strong { color: #fff; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* --- COMPETITOR DARK THEME STYLING --- */
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
      background: #121212; /* Dark Background */
      color: #fff;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }

    /* Font & General Styles Override */
    .product__title h1 {
      color: #FFF !important;
      font-family: sans-serif; /* Replace with 'Neue Montreal' if uploaded */
      font-weight: 400;
      font-size: 32px;
      line-height: 1.3;
    }
    
    .product__text, .price__regular, .price__sale {
      color: #B0B0B0;
    }
    
    .price-item--sale, .price-item--regular {
      color: #E9E2D8 !important;
      font-size: 24px;
    }

    /* Benefits Grid Style */
    .benefits-grid { margin: 20px 0; color: #b0b0b0; }
    .benefits-grid__list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .benefits-grid__item { display: flex; align-items: center; gap: 8px; }
    .benefits-grid__text { font-size: 13px; line-height: 1.4; color: #b0b0b0; }
    .benefits-grid__text strong { color: #fff; }

    /* Size/Bundle Tabs Style */
    .pb-wrap { margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
    .pb-label { display: block; margin-bottom: 10px; font-weight: 500; color: #fff; }
    .pb-size-tabs { display: flex; flex-wrap: wrap; gap: 10px; }
    .pb-size-tab {
      padding: 10px 15px;
      border: 1px solid #454545;
      color: #B0B0B0;
      background: transparent;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
    }
    .pb-size-tab.is-active, .pb-size-tab:hover {
      border-color: #fff;
      color: #fff;
      background: #1e1e1e;
    }

    /* Add To Cart Button Style */
    .custom-atc-btn {
      width: 100%;
      padding: 18px;
      margin-top: 20px;
      border: none;
      border-radius: 16px;
      background: #ffffff;
      color: #121212;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .custom-atc-btn:hover { opacity: 0.9; }
    .custom-atc-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Shipping Bar */
    .shipbar { margin: 20px 0; background: #03231A; border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 15px; }
    .shipbar__text { font-size: 12px; color: #D2F1E3; }
    
    /* Product Info Tabs (Accordion style) */
    .pit-tabs { display: flex; border-bottom: 1px solid #454545; margin: 24px 0; }
    .pit-tab {
      flex: 1; text-align: center; padding: 12px; background: transparent; border: none; color: #B0B0B0; cursor: pointer; border-bottom: 2px solid transparent;
    }
    .pit-tab.is-active { color: #fff; border-bottom-color: #fff; }
    .pit-panel { display: none; padding: 15px 0; color: #B0B0B0; }
    .pit-panel.is-active { display: block; }
    .pit-panel strong { color: #fff; }

  {%- endstyle -%}

  <div class="page-width">
    <div class="product grid grid--1-col {% if product.media.size > 0 %}grid--2-col-tablet{% else %}product--no-media{% endif %}">
      
      <div class="grid__item product__media-wrapper">
        {% render 'product-media-gallery', variant_images: variant_images %}
      </div>

      <div class="product__info-wrapper grid__item">
        <div id="ProductInfo-{{ section.id }}" class="product__info-container">
          
          {%- assign product_form_id = 'product-form-' | append: section.id -%}

          <h1 class="product__title">{{ product.title | escape }}</h1>

          <div class="no-js-hidden" id="price-{{ section.id }}" role="status">
            {%- render 'price', product: product, use_variant: true, show_badges: true, price_class: 'price--large' -%}
          </div>

          {% if product.description != blank %}
            <div class="product__description rte quick-add-hidden" style="color: #B0B0B0; margin-bottom: 20px;">
               {{ product.description | truncatewords: 30 }}
            </div>
          {% endif %}

          <div class="benefits-grid">
            <div class="benefits-grid__list">
              <div class="benefits-grid__item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#fff" stroke-width="2"/><path d="M8 12L11 15L16 9" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div class="benefits-grid__text">No PFAS, PTFE & PFOA.<br><strong>No hormone disruptors.</strong></div>
              </div>
              <div class="benefits-grid__item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3V5M12 19V21M5 12H3M21 12H19" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
                <div class="benefits-grid__text">Extreme Heat Resistant<br><strong>up to 600¬∞C</strong></div>
              </div>
              <div class="benefits-grid__item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="#fff" stroke-width="2"/></svg>
                <div class="benefits-grid__text">Constructed <strong>Non-Stick Surface</strong></div>
              </div>
              <div class="benefits-grid__item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="#fff" stroke-width="2"/></svg>
                <div class="benefits-grid__text">Compatible With <strong>All Cooktops</strong></div>
              </div>
            </div>
          </div>

          <div class="pb-wrap">
            <label class="pb-label">Select Variant:</label>
            <div class="pb-size-tabs">
              {%- unless product.has_only_default_variant -%}
                {%- for variant in product.variants -%}
                  <button type="button" 
                          class="pb-size-tab {% if forloop.first %}is-active{% endif %}" 
                          data-id="{{ variant.id }}"
                          data-price="{{ variant.price | money }}"
                          data-available="{{ variant.available }}">
                    {{ variant.title }}
                  </button>
                {%- endfor -%}
              {%- else -%}
                 <button type="button" class="pb-size-tab is-active" data-id="{{ product.selected_or_first_available_variant.id }}">Standard</button>
              {%- endunless -%}
            </div>
          </div>

          <div class="pb-atc-wrap">
            <button type="button" id="custom-atc-btn" class="custom-atc-btn">
              Add To Cart - <span id="atc-price-display">{{ product.selected_or_first_available_variant.price | money }}</span>
            </button>
            <div id="atc-error-msg" style="color: red; display: none; margin-top: 10px; font-size: 14px;"></div>
          </div>

          <div class="shipbar">
             <div style="flex-shrink:0;">üöö</div>
             <div class="shipbar__text">
               <strong>Free Shipping & Easy Returns</strong><br>
               30-Day Guarantee ‚Ä¢ Lifetime Warranty ‚Ä¢ 100% Toxin-Free
             </div>
          </div>

          <div class="pit-container">
            <div class="pit-tabs">
              <button class="pit-tab is-active" data-target="panel-1">Description</button>
              <button class="pit-tab" data-target="panel-2">Health Benefits</button>
              <button class="pit-tab" data-target="panel-3">Care & Use</button>
            </div>
            <div id="panel-1" class="pit-panel is-active">
              {{ product.description }}
            </div>
            <div id="panel-2" class="pit-panel">
              <p><strong>Pure Titanium:</strong> The safest metal for the body. Used in medical implants, naturally non-toxic.</p>
              <p><strong>Retains Nutrients:</strong> Cooks evenly at lower temperatures preventing nutrient loss.</p>
            </div>
            <div id="panel-3" class="pit-panel">
              <p>Dishwasher safe. Titanium interior is safe for abrasive scrubs. Works on Induction, Gas, and Electric.</p>
            </div>
          </div>

          <form method="post" action="/cart/add" id="product_form_id" accept-charset="UTF-8" class="product-form" enctype="multipart/form-data" novalidate="novalidate" data-type="add-to-cart-form">
            <input type="hidden" name="form_type" value="product">
            <input type="hidden" name="utf8" value="‚úì">
            <input type="hidden" name="id" id="real-variant-id" value="{{ product.selected_or_first_available_variant.id }}">
          </form>

        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // 1. Variant Selection Logic
  const tabs = document.querySelectorAll('.pb-size-tab');
  const realInput = document.getElementById('real-variant-id');
  const priceDisplay = document.getElementById('atc-price-display');

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // UI Update
      tabs.forEach(t => t.classList.remove('is-active'));
      this.classList.add('is-active');
      
      // Data Update
      const vid = this.getAttribute('data-id');
      const price = this.getAttribute('data-price');
      const available = this.getAttribute('data-available') === 'true';
      
      realInput.value = vid;
      if(price) priceDisplay.innerText = price;
      
      // Availability Check
      const btn = document.getElementById('custom-atc-btn');
      if(!available) {
        btn.disabled = true;
        btn.innerText = 'Sold Out';
      } else {
        btn.disabled = false;
        btn.innerHTML = 'Add To Cart - ' + price;
      }
    });
  });

  // 2. Custom Tabs Logic
  const infoTabs = document.querySelectorAll('.pit-tab');
  const infoPanels = document.querySelectorAll('.pit-panel');

  infoTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      infoTabs.forEach(t => t.classList.remove('is-active'));
      infoPanels.forEach(p => p.classList.remove('is-active'));
      
      this.classList.add('is-active');
      const target = this.getAttribute('data-target');
      document.getElementById(target).classList.add('is-active');
    });
  });

  // 3. AJAX ADD TO CART & DRAWER OPENING (Fixing your main issue)
  const atcBtn = document.getElementById('custom-atc-btn');
  
  atcBtn.addEventListener('click', function(e) {
    e.preventDefault();
    
    const variantId = document.getElementById('real-variant-id').value;
    const originalText = atcBtn.innerText;
    atcBtn.innerText = 'Adding...';
    
    let formData = {
     'items': [{
      'id': variantId,
      'quantity': 1
      }]
    };

    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      // Update Cart Drawer
      // Standard Dawn Theme uses 'cart-drawer' element
      const cartDrawer = document.querySelector('cart-drawer');
      const cartNotification = document.querySelector('cart-notification');

      // Fetch fresh cart HTML
      fetch(window.Shopify.routes.root + '?section_id=cart-drawer')
        .then((response) => response.text())
        .then((responseText) => {
          const html = new DOMParser().parseFromString(responseText, 'text/html');
          
          if (cartDrawer) {
             const selectors = ['cart-drawer-items', '.cart-drawer__footer'];
             selectors.forEach((selector) => {
                const targetElement = cartDrawer.querySelector(selector);
                const sourceElement = html.querySelector(selector);
                if (targetElement && sourceElement) {
                  targetElement.replaceWith(sourceElement);
                }
             });
             cartDrawer.open(); // Open the drawer specifically
          } 
          else if (cartNotification) {
             cartNotification.renderContents(data); // Fallback for notification style
          }
          else {
             // If no drawer exists, go to cart page
             window.location.href = '/cart';
          }
        });

      atcBtn.innerText = 'Added!';
      setTimeout(() => { atcBtn.innerText = originalText; }, 2000);
    })
    .catch((error) => {
      console.error('Error:', error);
      document.getElementById('atc-error-msg').style.display = 'block';
      document.getElementById('atc-error-msg').innerText = "Error adding to cart. Please try again.";
      atcBtn.innerText = originalText;
    });
  });

});
</script>
<div id="sticky-cta-wrapper" class="sticky-cta is-off">
  <div class="sticky-cta__thumb">
    {{ product.featured_image | image_url: width: 100 | image_tag }}
  </div>
  <div class="sticky-cta__body">
    <div class="sticky-cta__title">{{ product.title }}</div>
    <div class="sticky-cta__alert">
      <span style="color:#ff2422; font-weight:bold;">‚ö†Ô∏è ALMOST SOLD OUT</span>
    </div>
  </div>
  <button type="button" class="sticky-cta__btn" onclick="document.querySelector('.product-form__submit').click()">ADD TO CART</button>
</div>

<style>
  .sticky-cta {
    position: fixed; z-index: 9998; bottom: 20px; right: 20px;
    display: flex; align-items: center; gap: 15px;
    background: #1a1a1a; color: #fff; padding: 10px; border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    transform: translateY(100px); opacity: 0; transition: all 0.3s ease;
  }
  .sticky-cta.is-on { transform: translateY(0); opacity: 1; }
  .sticky-cta__thumb img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
  .sticky-cta__title { font-size: 14px; font-weight: 600; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sticky-cta__btn {
    background: #fff; color: #000; border: none; padding: 10px 20px;
    font-weight: bold; border-radius: 8px; cursor: pointer;
  }
  @media(max-width: 768px) {
    .sticky-cta { left: 0; right: 0; bottom: 0; border-radius: 0; justify-content: space-between; width: 100%; }
    .sticky-cta__thumb, .sticky-cta__body { display: none; }
    .sticky-cta__btn { width: 100%; }
  }
</style>

<script>
  window.addEventListener('scroll', () => {
    const cta = document.getElementById('sticky-cta-wrapper');
    const mainBtn = document.querySelector('.product-form__submit');
    if(mainBtn && cta) {
      const rect = mainBtn.getBoundingClientRect();
      if(rect.bottom < 0) cta.classList.add('is-on');
      else cta.classList.remove('is-on');
    }
  });
</script>


<div id="sg-modal" class="sg-modal" hidden>
  <div class="sg-backdrop" onclick="document.getElementById('sg-modal').hidden = true"></div>
  <div class="sg-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h2 style="color:#000; margin:0;">Size Guide</h2>
      <button onclick="document.getElementById('sg-modal').hidden = true" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
    </div>
    <table class="sg-table" style="width:100%; text-align:left; border-collapse:collapse; color:#000;">
      <thead style="background:#f4f4f4;">
        <tr><th style="padding:10px;">Size</th><th>Diameter</th><th>Length</th></tr>
      </thead>
      <tbody>
        <tr><td style="padding:10px; border-bottom:1px solid #ddd;">Standard</td><td>10.2"</td><td>18.9"</td></tr>
        <tr><td style="padding:10px; border-bottom:1px solid #ddd;">Large</td><td>11"</td><td>20"</td></tr>
        <tr><td style="padding:10px; border-bottom:1px solid #ddd;">Extra Large</td><td>11.8"</td><td>21"</td></tr>
      </tbody>
    </table>
  </div>
</div>

<style>
  .sg-modal { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; }
  .sg-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
  .sg-panel { position: relative; background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; }
  /* Trigger Link styling - add class 'trigger-size-guide' to any text to open this */
</style>
{% schema %}
{
  "name": "Main Product (Custom)",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "default": "Text block",
          "label": "Text"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ]
}
{% endschema %}