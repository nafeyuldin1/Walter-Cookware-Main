<section id="MainProduct-{{ section.id }}" class="section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}" data-section="{{ section.id }}">
  
  {{ 'section-main-product.css' | asset_url | stylesheet_tag }}
  {{ 'component-accordion.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  {{ 'component-slider.css' | asset_url | stylesheet_tag }}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-loading-spinner.css' | asset_url | stylesheet_tag }}
  {{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}

  {% unless product.has_only_default_variant %}
    {{ 'component-product-variant-picker.css' | asset_url | stylesheet_tag }}
    {{ 'component-swatch-input.css' | asset_url | stylesheet_tag }}
    {{ 'component-swatch.css' | asset_url | stylesheet_tag }}
  {% endunless %}

  {%- style -%}
    /* --- 1. DARK THEME STYLING --- */
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
      background-color: #121212 !important;
      color: #ffffff !important;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }

    /* Text Colors */
    h1, h2, h3, .h1, .h2, .product__title h1 { color: #ffffff !important; font-weight: 400; letter-spacing: 1px; }
    .product__text, .product__description, .product__description p, .price-item { color: #B0B0B0 !important; }
    .price-item--sale { color: #E9E2D8 !important; }
    .product__title a { text-decoration: none; }
    .product__media-wrapper { background: transparent !important; }

    /* --- 2. COMPONENTS STYLING --- */
    .benefits-grid { margin: 20px 0; border-top: 1px solid #333; padding-top: 20px; }
    .benefits-grid__list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .benefits-grid__item { display: flex; align-items: center; gap: 10px; }
    .benefits-grid__text { font-size: 12px; line-height: 1.4; color: #b0b0b0; }
    .benefits-grid__text strong { color: #fff; }

    .shipbar { margin: 20px 0; background: #03231A; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 15px; }
    .shipbar__text { font-size: 12px; color: #D2F1E3; font-weight: 500; }

    .pit-container { margin-top: 30px; border-top: 1px solid #454545; }
    .pit-tabs { display: flex; border-bottom: 1px solid #454545; margin-bottom: 15px; }
    .pit-tab { flex: 1; padding: 15px; background: transparent; border: none; color: #B0B0B0; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; }
    .pit-tab.is-active { color: #fff; border-bottom-color: #fff; }
    .pit-panel { display: none; color: #B0B0B0; font-size: 14px; line-height: 1.6; }
    .pit-panel.is-active { display: block; animation: fadeIn 0.5s; }

    .sticky-cta { position: fixed; z-index: 99; bottom: 20px; right: 20px; background: #1a1a1a; padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(200%); transition: transform 0.3s ease; border: 1px solid #333; }
    .sticky-cta.is-visible { transform: translateY(0); }
    .sticky-cta img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
    .sticky-cta button { background: #fff; color: #000; border: none; padding: 10px 20px; font-weight: bold; border-radius: 6px; cursor: pointer; }

    .upsell-section { margin-top: 40px; border-top: 1px solid #333; padding-top: 30px; }
    .upsell-card { background: #fff; border-radius: 12px; padding: 15px; display: flex; gap: 15px; align-items: center; margin-top:10px; }

    .sg-modal { position: fixed; inset: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
    .sg-panel { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; position: relative; color: #000; }
    .sg-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #000; }
    .sg-table td, .sg-table th { padding: 10px; border-bottom: 1px solid #eee; text-align: left; color:#000; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  {%- endstyle -%}

  <script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'media-gallery.js' | asset_url }}" defer="defer"></script>

  {% assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src' %}

  <div class="page-width">
    <div class="product grid grid--1-col grid--2-col-tablet">
      <div class="grid__item product__media-wrapper">
        {% render 'product-media-gallery', variant_images: variant_images %}
      </div>
      <div class="product__info-wrapper grid__item">
        <product-info id="ProductInfo-{{ section.id }}" class="product__info-container" data-section="{{ section.id }}" data-url="{{ product.url }}">
          {%- assign product_form_id = 'product-form-' | append: section.id -%}

          {%- for block in section.blocks -%}
            {%- case block.type -%}
              {%- when '@app' -%}
                {% render block %}
              {%- when 'text' -%}
                <p class="product__text inline-richtext" {{ block.shopify_attributes }}>{{ block.settings.text }}</p>
              {%- when 'title' -%}
                <h1 class="product__title" {{ block.shopify_attributes }}>{{ product.title | escape }}</h1>
              {%- when 'price' -%}
                <div id="price-{{ section.id }}" {{ block.shopify_attributes }}>
                  {%- render 'price', product: product, use_variant: true, show_badges: true, price_class: 'price--large' -%}
                </div>
                <div class="benefits-grid">
                  <div class="benefits-grid__list">
                    <div class="benefits-grid__item">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#fff" stroke-width="2"/><path d="M8 12L11 15L16 9" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      <div class="benefits-grid__text">No PFAS/PFOA.<br><strong>No hormone disruptors.</strong></div>
                    </div>
                    <div class="benefits-grid__item">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 3V5M12 19V21M5 12H3M21 12H19" stroke="#fff" stroke-width="2"/></svg>
                      <div class="benefits-grid__text">Heat Resistant<br><strong>up to 600¬∞C</strong></div>
                    </div>
                  </div>
                </div>
              {%- when 'description' -%}
                <div class="product__description rte" {{ block.shopify_attributes }}>{{ product.description | truncatewords: 30 }}</div>
              {%- when 'variant_picker' -%}
                {% render 'product-variant-picker', product: product, block: block, product_form_id: product_form_id %}
                <button type="button" class="size-guide-trigger" style="background:none; border:none; color:#fff; text-decoration:underline; cursor:pointer; margin-top:10px;">üìè Size Guide</button>
              {%- when 'buy_buttons' -%}
                {%- render 'buy-buttons', block: block, product: product, product_form_id: product_form_id, section_id: section.id, show_pickup_availability: true -%}
                <div class="shipbar">
                   <div style="font-size: 24px;">üöö</div>
                   <div class="shipbar__text"><strong>Free Shipping & Easy Returns</strong><br>30-Day Guarantee ‚Ä¢ Lifetime Warranty</div>
                </div>
              {%- when 'rating' -%}
                {%- if product.metafields.reviews.rating.value != blank -%}
                  <div class="rating-wrapper">{% render 'rating', product: product %}</div>
                {%- endif -%}
            {%- endcase -%}
          {%- endfor -%}

          <div class="pit-container">
            <div class="pit-tabs">
              <button class="pit-tab is-active" data-target="panel-desc">Description</button>
              <button class="pit-tab" data-target="panel-health">Health Benefits</button>
            </div>
            <div id="panel-desc" class="pit-panel is-active">{{ product.description }}</div>
            <div id="panel-health" class="pit-panel"><p>Naturally non-toxic titanium. Safe for induction and gas.</p></div>
          </div>

          <div class="upsell-section">
            <h3 style="color:#fff; font-size:18px;">Complete Your Kitchen</h3>
            <div class="upsell-card">
              <div style="width:60px; height:60px; background:#eee; border-radius:8px;"></div>
              <div style="flex:1;"><div style="font-weight:bold; color:#000;">Titanium Utensils</div><div style="font-size:12px; color:#555;">$199.00</div></div>
              <button class="js-force-add-btn" data-variant-id="{{ product.selected_or_first_available_variant.id }}" style="background:#A3835F; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Add</button>
            </div>
          </div>
        </product-info>
      </div>
    </div>
  </div>
</section>

<div id="sticky-cta-wrapper" class="sticky-cta">
  <div style="display:flex; gap:10px; align-items:center;">
    <img src="{{ product.featured_image | image_url: width: 100 }}">
    <div style="color:#fff;">
      <div style="font-weight:bold; font-size:14px;">{{ product.title | truncate: 20 }}</div>
      <div style="color:#ff2422; font-size:12px; font-weight:bold;">‚ö†Ô∏è ALMOST SOLD OUT</div>
    </div>
  </div>
  <button id="sticky-add-to-cart">ADD TO CART</button>
</div>

<div id="sg-modal" class="sg-modal" hidden>
  <div class="sg-panel">
    <button class="sg-close" onclick="document.getElementById('sg-modal').hidden = true">&times;</button>
    <h2>Size Guide</h2>
    <table class="sg-table" style="width:100%;">
      <thead><tr style="background:#f4f4f4;"><th>Size</th><th>Diameter</th></tr></thead>
      <tbody><tr><td>Standard</td><td>10.2"</td></tr><tr><td>Large</td><td>11.8"</td></tr></tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // --- 1. UTILITY: Refresh Drawer & Open It ---
  function updateAndOpenCart() {
    const cartDrawer = document.querySelector('cart-drawer');
    const cartIcon = document.querySelector('#cart-icon-bubble');

    // Fetch updated sections: drawer and the header icon bubble
    fetch(`${window.Shopify.routes.root}?sections=cart-drawer,cart-icon-bubble`)
      .then(res => res.json())
      .then(sections => {
        // Update Cart Icon Count (Bubble)
        if (cartIcon && sections['cart-icon-bubble']) {
          cartIcon.innerHTML = sections['cart-icon-bubble'];
        }

        // Update Drawer Content
        if (cartDrawer && sections['cart-drawer']) {
          const html = new DOMParser().parseFromString(sections['cart-drawer'], 'text/html');
          const drawerInner = html.querySelector('.drawer__inner');
          const currentDrawerInner = cartDrawer.querySelector('.drawer__inner');
          
          if (drawerInner && currentDrawerInner) {
            currentDrawerInner.innerHTML = drawerInner.innerHTML;
          }
          
          cartDrawer.classList.remove('is-empty');

          // Trigger Dawn's internal open method
          if (typeof cartDrawer.open === 'function') {
            cartDrawer.open();
          } else {
            cartDrawer.setAttribute('open', '');
          }
        }
      })
      .catch(err => {
        console.error('Drawer Update Error:', err);
        // Fallback: Agar error aaye toh cart page pe bhej do
        window.location.href = window.Shopify.routes.root + 'cart';
      });
  }

  // --- 2. CORE: AJAX Add to Cart Function ---
  function forceAddToCart(formData, button) {
    if (button) {
      button.disabled = true;
      button.classList.add('loading');
      const spinner = button.querySelector('.loading__spinner');
      if (spinner) spinner.classList.remove('hidden');
    }

    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.status && data.status === 422) {
        // Error handling (e.g., out of stock)
        alert(data.description);
      } else {
        // Success: Trigger Drawer
        updateAndOpenCart();
      }
    })
    .catch(err => {
      console.error('AJAX ATC Error:', err);
    })
    .finally(() => {
      if (button) {
        button.disabled = false;
        button.classList.remove('loading');
        const spinner = button.querySelector('.loading__spinner');
        if (spinner) spinner.classList.add('hidden');
      }
    });
  }

  // --- 3. EVENT: Intercept Main Product Form ---
  const mainProductForm = document.querySelector('product-form form');
  if (mainProductForm) {
    mainProductForm.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopImmediatePropagation();
      forceAddToCart(new FormData(mainProductForm), mainProductForm.querySelector('[type="submit"]'));
    });
  }

  // --- 4. EVENT: Sticky ATC Button ---
  const stickyBtn = document.getElementById('sticky-add-to-cart');
  if (stickyBtn) {
    stickyBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (mainProductForm) {
        const formData = new FormData(mainProductForm);
        forceAddToCart(formData, stickyBtn);
      }
    });

    // Sticky Visibility on Scroll
    window.addEventListener('scroll', () => {
      const ctaWrapper = document.getElementById('sticky-cta-wrapper');
      const mainSubmit = document.querySelector('.product-form__submit');
      if (mainSubmit && ctaWrapper) {
        if (mainSubmit.getBoundingClientRect().bottom < 0) {
          ctaWrapper.classList.add('is-visible');
        } else {
          ctaWrapper.classList.remove('is-visible');
        }
      }
    });
  }

  // --- 5. EVENT: Upsell Buttons (.js-force-add-btn) ---
  document.querySelectorAll('.js-force-add-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const variantId = this.dataset.variantId;
      if (!variantId) return;

      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', 1);
      
      forceAddToCart(formData, this);
    });
  });

  // --- 6. UI: Tabs Logic ---
  document.querySelectorAll('.pit-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const targetPanel = document.getElementById(this.dataset.target);
      if (!targetPanel) return;

      document.querySelectorAll('.pit-tab').forEach(t => t.classList.remove('is-active'));
      document.querySelectorAll('.pit-panel').forEach(p => p.classList.remove('is-active'));

      this.classList.add('is-active');
      targetPanel.classList.add('is-active');
    });
  });

  // --- 7. UI: Size Guide Modal ---
  const sizeGuideBtn = document.querySelector('.size-guide-trigger');
  const sizeModal = document.getElementById('sg-modal');
  if (sizeGuideBtn && sizeModal) {
    sizeGuideBtn.addEventListener('click', (e) => {
      e.preventDefault();
      sizeModal.hidden = false;
    });
  }

});
</script>

{% schema %}
{
  "name": "Custom Product Section",
  "tag": "section",
  "blocks": [
    {"type": "@app"},
    {"type": "text", "name": "Text", "settings": [{"type": "inline_richtext", "id": "text", "label": "Text"}]},
    {"type": "title", "name": "Title", "limit": 1},
    {"type": "price", "name": "Price", "limit": 1},
    {"type": "variant_picker", "name": "Variant Picker", "limit": 1},
    {"type": "buy_buttons", "name": "Buy Buttons", "limit": 1, "settings": [{"type": "checkbox", "id": "show_dynamic_checkout", "default": true, "label": "Show Dynamic Checkout"}]},
    {"type": "description", "name": "Description", "limit": 1},
    {"type": "rating", "name": "Rating", "limit": 1}
  ],
  "settings": [
    {"type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Top Padding", "default": 36},
    {"type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Bottom Padding", "default": 36}
  ]
}
{% endschema %}