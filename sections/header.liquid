<link rel="stylesheet" href="{{ 'component-list-menu.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-search.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-menu-drawer.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-cart-notification.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-price.css' | asset_url }}" media="print" onload="this.media='all'">

{%- if section.settings.menu_type_desktop == 'mega' -%}
  <link rel="stylesheet" href="{{ 'component-mega-menu.css' | asset_url }}" media="print" onload="this.media='all'">
{%- endif -%}

<style>
  header-drawer { justify-self: start; margin-left: -1.2rem; }
  {%- if section.settings.sticky_header_type == 'reduce-logo-size' -%}
    .scrolled-past-header .header__heading-logo-wrapper { width: 75%; }
  {%- endif -%}
  {%- if section.settings.menu_type_desktop != "drawer" -%}
    @media screen and (min-width: 990px) { header-drawer { display: none; } }
  {%- endif -%}
  .menu-drawer-container { display: flex; }
  .list-menu { list-style: none; padding: 0; margin: 0; }
  .list-menu--inline { display: inline-flex; flex-wrap: wrap; }
  summary.list-menu__item { padding-right: 2.7rem; }
  .list-menu__item { display: flex; align-items: center; line-height: calc(1 + 0.3 / var(--font-body-scale)); }
  .list-menu__item--link { text-decoration: none; padding-bottom: 1rem; padding-top: 1rem; line-height: calc(1 + 0.8 / var(--font-body-scale)); }
  @media screen and (min-width: 750px) { .list-menu__item--link { padding-bottom: 0.5rem; padding-top: 0.5rem; } }
  
  /* Sticky Header Blur & Color */
  {% if section.settings.enable_sticky_blur %}
    .shopify-section-header-sticky .header-wrapper {
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      background-color: rgba(var(--color-background), {{ section.settings.sticky_opacity | divided_by: 100.0 }}) !important;
    }
  {% endif %}

  /* --- DESKTOP MEGA MENU CSS --- */
  .cat-strip { display: flex; justify-content: center; gap: 20px; padding: 0 20px; background: rgb(var(--color-background)); border-top: 1px solid rgba(0,0,0,0.05); border-bottom: 1px solid rgba(0,0,0,0.05); overflow-x: auto; }
  .cat-strip__item { background: none; border: none; font-size: 13px; font-weight: 700; text-transform: uppercase; cursor: pointer; padding: 12px 5px; color: rgb(var(--color-foreground)); border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s; letter-spacing: 0.5px; }
  .cat-strip__item:hover, .cat-strip__item.is-active { opacity: 0.7; border-bottom-color: rgb(var(--color-foreground)); }
  
  .cat-portals-wrapper { position: absolute; left: 0; top: 100%; width: 100%; background: #fff; border-bottom: 1px solid #e5e5e5; z-index: 99; box-shadow: 0 15px 30px rgba(0,0,0,0.08); display: none; }
  .cat-portals-wrapper.is-open { display: block; animation: fadeIn 0.3s ease; }
  
  .cat-portal { display: none; max-width: 1400px; margin: 0 auto; padding: 40px; gap: 40px; }
  .cat-portal[aria-hidden="false"] { display: flex; }
  
  .cat-portal__left { width: 25%; padding-right: 30px; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; justify-content: space-between; }
  .cat-portal__title { font-size: 22px; font-weight: 800; margin: 0 0 10px 0; color: inherit; }
  .cat-portal__link { font-size: 14px; font-weight: 600; text-decoration: underline; color: #444; }
  .cat-portal__desc { font-size: 14px; line-height: 1.5; color: #555; margin-top: 15px; font-style: italic; }
  
  .cat-portal__grid { width: 75%; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
  .cat-prod { text-decoration: none; color: inherit; text-align: center; }
  .cat-prod__media { position: relative; display: block; border-radius: 8px; overflow: hidden; margin-bottom: 10px; aspect-ratio: 1; background: #f4f4f4; }
  .cat-prod__media img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
  .cat-prod:hover .cat-prod__media img { transform: scale(1.05); }
  .cat-prod__badge { position: absolute; top: 8px; left: 8px; background: #932933; color: #fff; font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 4px; z-index: 2; }
  .cat-prod__title { font-size: 13px; font-weight: 600; margin-bottom: 5px; color: inherit; line-height: 1.3; }
  .cat-prod__price { font-size: 13px; }
  .cat-prod__price .cmp { text-decoration: line-through; color: #888; margin-right: 5px; }
  .cat-prod__price .prc { font-weight: 700; color: inherit; }

  @media screen and (max-width: 990px) { .cat-strip, .cat-portals-wrapper { display: none !important; } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>

{%- style -%}
  .header { padding: {{ section.settings.padding_top | times: 0.5 | round: 0 }}px 3rem {{ section.settings.padding_bottom | times: 0.5 | round: 0 }}px 3rem; }
  .section-header { position: sticky; margin-bottom: {{ section.settings.margin_bottom | times: 0.75 | round: 0 }}px; }
  @media screen and (min-width: 750px) { .section-header { margin-bottom: {{ section.settings.margin_bottom }}px; } }
  @media screen and (min-width: 990px) { .header { padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px; } }
{%- endstyle -%}

<script src="{{ 'cart-notification.js' | asset_url }}" defer="defer"></script>

{% liquid
  assign header_tag = 'div'
  if section.settings.sticky_header_type != 'none'
    assign header_tag = 'sticky-header'
  endif
  assign header_color_scheme = section.settings.color_scheme
  if request.page_type == 'index'
    assign header_color_scheme = section.settings.color_scheme_home
  endif
%}

<{{ header_tag }}
  {% if header_tag == 'sticky-header' %}
    data-sticky-type="{{ section.settings.sticky_header_type }}"
    data-default-color-scheme="color-{{ header_color_scheme }}"
    data-sticky-color-scheme="color-{{ section.settings.color_scheme_sticky }}"
  {% endif %}
  class="header-wrapper color-{{ header_color_scheme }} gradient{% if section.settings.show_line_separator %} header-wrapper--border-bottom{% endif %}"
>
  <header class="header header--{{ section.settings.logo_position }} header--mobile-{{ section.settings.mobile_logo_position }} page-width{% if section.settings.menu_type_desktop == 'drawer' %} drawer-menu{% endif %}{% if section.settings.menu != blank %} header--has-menu{% endif %}">
    
    {%- if section.settings.menu != blank -%}
      {% render 'header-drawer' %}
    {%- endif -%}

    {%- if section.settings.logo_position == 'top-center' or section.settings.menu == blank -%}
      <details-modal class="header__search">
        <details>
          <summary class="header__icon header__icon--search header__icon--summary link focus-inset modal__toggle" aria-haspopup="dialog" aria-label="{{ 'general.search.search' | t }}">
            <span>
              <svg class="modal__toggle-open icon icon-search" aria-hidden="true" focusable="false" role="presentation"><use href="#icon-search"></use></svg>
              <svg class="modal__toggle-close icon icon-close" aria-hidden="true" focusable="false" role="presentation"><use href="#icon-close"></use></svg>
            </span>
          </summary>
          <div class="search-modal modal__content gradient" role="dialog" aria-modal="true" aria-label="{{ 'general.search.search' | t }}">
            <div class="modal-overlay"></div>
            <div class="search-modal__content{% if settings.inputs_shadow_vertical_offset != 0 and settings.inputs_shadow_vertical_offset < 0 %} search-modal__content-top{% endif %}" tabindex="-1">
              {%- if settings.predictive_search_enabled -%}
                <predictive-search class="search-modal__form" data-loading-text="{{ 'accessibility.loading' | t }}">
              {%- endif -%}
                <form action="{{ routes.search_url }}" method="get" role="search" class="search search-modal__form">
                  <div class="field">
                    <input class="search__input field__input" id="Search-In-Modal-1" type="search" name="q" value="" placeholder="{{ 'general.search.search' | t }}">
                    <label class="field__label" for="Search-In-Modal-1">{{ 'general.search.search' | t }}</label>
                    <button class="search__button field__button" aria-label="{{ 'general.search.search' | t }}"><svg class="icon icon-search" aria-hidden="true" focusable="false" role="presentation"><use href="#icon-search"></use></svg></button>
                  </div>
                </form>
              {%- if settings.predictive_search_enabled -%}
                </predictive-search>
              {%- endif -%}
            </div>
          </div>
        </details>
      </details-modal>
    {%- endif -%}

    {%- if section.settings.logo_position != 'middle-center' -%}
      {%- if request.page_type == 'index' -%}<h1 class="header__heading">{%- endif -%}
      <a href="{{ routes.root_url }}" class="header__heading-link link link--text focus-inset">
        {%- if settings.logo != blank -%}
          <div class="header__heading-logo-wrapper">
            {%- assign logo_alt = settings.logo.alt | default: shop.name | escape -%}
            {{ settings.logo | image_url: width: 600 | image_tag: class: 'header__heading-logo', width: section.settings.logo_width, alt: logo_alt, preload: true }}
          </div>
        {%- else -%}
          <span class="h2">{{ shop.name }}</span>
        {%- endif -%}
      </a>
      {%- if request.page_type == 'index' -%}</h1>{%- endif -%}
    {%- endif -%}

    {%- if section.settings.menu != blank -%}
      {%- if section.settings.menu_type_desktop == 'dropdown' -%}
        {% render 'header-dropdown-menu' %}
      {%- elsif section.settings.menu_type_desktop != 'drawer' -%}
        {% render 'header-mega-menu' %}
      {%- endif -%}
    {%- endif -%}

    {%- if section.settings.logo_position == 'middle-center' -%}
      {%- if request.page_type == 'index' -%}<h1 class="header__heading">{%- endif -%}
      <a href="{{ routes.root_url }}" class="header__heading-link link link--text focus-inset">
        {%- if settings.logo != blank -%}
          <div class="header__heading-logo-wrapper">
            {%- assign logo_alt = settings.logo.alt | default: shop.name | escape -%}
            {{ settings.logo | image_url: width: 600 | image_tag: class: 'header__heading-logo', width: section.settings.logo_width, alt: logo_alt, preload: true }}
          </div>
        {%- else -%}
          <span class="h2">{{ shop.name }}</span>
        {%- endif -%}
      </a>
      {%- if request.page_type == 'index' -%}</h1>{%- endif -%}
    {%- endif -%}

    <div class="header__icons">
      <details-modal class="header__search">
        <details>
            <summary class="header__icon header__icon--search header__icon--summary link focus-inset modal__toggle">
                <span><svg class="icon icon-search" aria-hidden="true" focusable="false"><use href="#icon-search"></use></svg></span>
            </summary>
             <div class="search-modal modal__content gradient" role="dialog" aria-modal="true" aria-label="{{ 'general.search.search' | t }}">
                </div>
        </details>
      </details-modal>
      <a href="{{ routes.cart_url }}" class="header__icon header__icon--cart link focus-inset" id="cart-icon-bubble">
        {% render 'icon-cart' %}
        <span class="visually-hidden">{{ 'templates.cart.cart' | t }}</span>
        {%- if cart != empty -%}
          <div class="cart-count-bubble">
            {%- if cart.item_count < 100 -%}<span aria-hidden="true">{{ cart.item_count }}</span>{%- endif -%}
            <span class="visually-hidden">{{ 'sections.header.cart_count' | t: count: cart.item_count }}</span>
          </div>
        {%- endif -%}
      </a>
    </div>
  </header>

  {%- assign mega_tabs = section.blocks | where: "type", "mega_tab" -%}
  {%- if mega_tabs.size > 0 -%}
    <div class="cat-strip" role="tablist">
      {%- for block in mega_tabs -%}
        <div class="color-{{ block.settings.color_scheme }} gradient" style="display:inline-block">
            <button class="cat-strip__item" role="tab" data-key="block-{{ block.id }}" style="color: rgb(var(--color-foreground));">
            {{ block.settings.tab_label }}
            </button>
        </div>
      {%- endfor -%}
    </div>

    <div id="cat-portals-wrapper" class="cat-portals-wrapper">
      {%- for block in mega_tabs -%}
        <section class="cat-portal color-{{ block.settings.color_scheme }} gradient" data-key="block-{{ block.id }}" aria-hidden="true">
          <aside class="cat-portal__left">
            <div>
              <h3 class="cat-portal__title">{{ block.settings.sidebar_title }}</h3>
              {% if block.settings.btn_link != blank %}
                <a class="cat-portal__link" href="{{ block.settings.btn_link }}">{{ block.settings.btn_label | default: "Shop All" }}</a>
              {% endif %}
              <div style="height:2px; width:40px; background:rgb(var(--color-foreground)); margin-top:15px;"></div>
            </div>
            {% if block.settings.review_text != blank %}
            <div>
              <div class="cat-portal__desc">"{{ block.settings.review_text }}"</div>
            </div>
            {% endif %}
          </aside>
          <div class="cat-portal__grid">
            {% assign collection = collections[block.settings.collection] %}
            {% if collection != blank %}
              {% for product in collection.products limit: 4 %}
                <a href="{{ product.url }}" class="cat-prod">
                  <div class="cat-prod__media">
                    <img src="{{ product.featured_image | image_url: width: 400 }}" loading="lazy" alt="{{ product.title }}">
                    {% if product.compare_at_price > product.price %}
                      <span class="cat-prod__badge">Sale</span>
                    {% endif %}
                  </div>
                  <div class="cat-prod__title">{{ product.title }}</div>
                  <div class="cat-prod__price">
                    <span class="prc">{{ product.price | money }}</span>
                  </div>
                </a>
              {% endfor %}
            {% endif %}
          </div>
        </section>
      {%- endfor -%}
    </div>
  {%- endif -%}
</{{ header_tag }}>

{%- if settings.cart_type == 'notification' -%}
  {%- render 'cart-notification', color_scheme: section.settings.color_scheme, desktop_menu_type: section.settings.menu_type_desktop -%}
{%- endif -%}

{% javascript %}
  class StickyHeader extends HTMLElement {
    constructor() { super(); }
    connectedCallback() {
      this.header = document.querySelector('.section-header');
      this.headerIsAlwaysSticky = this.getAttribute('data-sticky-type') === 'always' || this.getAttribute('data-sticky-type') === 'reduce-logo-size';
      this.headerBounds = {};
      this.setHeaderHeight();
      window.matchMedia('(max-width: 990px)').addEventListener('change', this.setHeaderHeight.bind(this));
      if (this.headerIsAlwaysSticky) { this.header.classList.add('shopify-section-header-sticky'); }
      this.currentScrollTop = 0;
      this.preventReveal = false;
      this.onScrollHandler = this.onScroll.bind(this);
      window.addEventListener('scroll', this.onScrollHandler, false);
      this.createObserver();
    }
    setHeaderHeight() { document.documentElement.style.setProperty('--header-height', `${this.header.offsetHeight}px`); }
    disconnectedCallback() { window.removeEventListener('scroll', this.onScrollHandler); }
    createObserver() {
      let observer = new IntersectionObserver((entries, observer) => {
        this.headerBounds = entries[0].intersectionRect;
        observer.disconnect();
      });
      observer.observe(this.header);
    }
    onScroll() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      if (scrollTop > this.currentScrollTop && scrollTop > this.headerBounds.bottom) {
        this.header.classList.add('scrolled-past-header');
        if (this.headerIsAlwaysSticky) return;
        this.header.classList.add('shopify-section-header-hidden', 'shopify-section-header-sticky');
      } else if (scrollTop < this.currentScrollTop && scrollTop > this.headerBounds.bottom) {
        this.header.classList.add('scrolled-past-header');
        if (this.headerIsAlwaysSticky) return;
        this.header.classList.add('shopify-section-header-sticky', 'animate');
        this.header.classList.remove('shopify-section-header-hidden');
      } else if (scrollTop <= this.headerBounds.top) {
        this.header.classList.remove('scrolled-past-header');
        if (this.headerIsAlwaysSticky) return;
        this.header.classList.remove('shopify-section-header-hidden', 'shopify-section-header-sticky', 'animate');
      }
      this.currentScrollTop = scrollTop;
    }
  }
  customElements.define('sticky-header', StickyHeader);

  document.addEventListener('DOMContentLoaded', function() {
    const wrapper = document.getElementById('cat-portals-wrapper');
    const tabs = document.querySelectorAll('.cat-strip__item');
    const portals = document.querySelectorAll('.cat-portal');
    const headerSection = document.querySelector('.section-header');

    if(!wrapper) return;

    function closeMenu() {
      wrapper.classList.remove('is-open');
      wrapper.style.display = 'none';
      tabs.forEach(t => t.classList.remove('is-active'));
      portals.forEach(p => p.setAttribute('aria-hidden', 'true'));
    }

    tabs.forEach(tab => {
      tab.addEventListener('mouseenter', function() {
        const key = this.dataset.key;
        tabs.forEach(t => t.classList.remove('is-active'));
        portals.forEach(p => p.setAttribute('aria-hidden', 'true'));
        
        this.classList.add('is-active');
        const target = document.querySelector(`.cat-portal[data-key="${key}"]`);
        
        if(target) {
          wrapper.style.display = 'block';
          setTimeout(() => wrapper.classList.add('is-open'), 10);
          target.setAttribute('aria-hidden', 'false');
        }
      });
    });
    headerSection.addEventListener('mouseleave', closeMenu);
  });
{% endjavascript %}

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "name": {{ shop.name | json }},
    {% if settings.logo %}
      "logo": {{ settings.logo | image_url: width: 500 | prepend: "https:" | json }},
    {% endif %}
    "url": {{ request.origin | append: page.url | json }}
  }
</script>

{% schema %}
{
  "name": "Header & Drawer",
  "class": "section-header",
  "max_blocks": 25,
  "settings": [
    {
      "type": "select",
      "id": "logo_position",
      "options": [
        { "value": "top-left", "label": "Top Left" },
        { "value": "top-center", "label": "Top Center" },
        { "value": "middle-left", "label": "Middle Left" },
        { "value": "middle-center", "label": "Middle Center" }
      ],
      "default": "middle-left",
      "label": "Logo Position (Desktop)"
    },
    {
      "type": "select",
      "id": "mobile_logo_position",
      "options": [
        { "value": "center", "label": "Center" },
        { "value": "left", "label": "Left" }
      ],
      "default": "center",
      "label": "Logo Position (Mobile)"
    },
    {
      "type": "link_list",
      "id": "menu",
      "default": "main-menu",
      "label": "Desktop Menu"
    },
    {
        "type": "select",
        "id": "menu_type_desktop",
        "options": [
            { "value": "dropdown", "label": "Dropdown" },
            { "value": "mega", "label": "Mega Menu" },
            { "value": "drawer", "label": "Drawer" }
        ],
        "default": "dropdown",
        "label": "Desktop Menu Type"
    },
    {
      "type": "select",
      "id": "sticky_header_type",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "on-scroll-up", "label": "On Scroll Up" },
        { "value": "always", "label": "Always" },
        { "value": "reduce-logo-size", "label": "Always (Reduce Logo)" }
      ],
      "default": "on-scroll-up",
      "label": "Sticky Header Type"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_blur",
      "default": true,
      "label": "Enable Blur on Sticky Header"
    },
    {
      "type": "range",
      "id": "sticky_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Sticky Header Opacity",
      "default": 85
    },
    {
      "type": "checkbox",
      "id": "show_line_separator",
      "default": true,
      "label": "Show Bottom Border"
    },
    {
      "type": "header",
      "content": "Color Schemes"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Default Page Header",
      "default": "scheme-1"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme_home",
      "label": "Home Page Header",
      "default": "scheme-1"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme_sticky",
      "label": "Sticky Header",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Mobile Drawer Settings"
    },
    {
       "type": "color_scheme",
       "id": "menu_color_scheme",
       "label": "Mobile Drawer Color Scheme",
       "default": "scheme-1"
    },
    {
        "type": "text",
        "id": "drawer_slider_title",
        "label": "Mobile Slider Title",
        "default": "BEST SELLERS - LOW STOCK ⚠️"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 36,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 36,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 20
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "mega_tab",
      "name": "Desktop Mega Tab",
      "settings": [
        { "type": "text", "id": "tab_label", "label": "Tab Label", "default": "Best Sellers" },
        { "type": "color_scheme", "id": "color_scheme", "label": "Color Scheme", "default": "scheme-1" },
        { "type": "collection", "id": "collection", "label": "Select Collection" },
        { "type": "text", "id": "sidebar_title", "label": "Sidebar Title" },
        { "type": "url", "id": "btn_link", "label": "Button Link" },
        { "type": "text", "id": "btn_label", "label": "Button Label", "default": "Shop All" },
        { "type": "textarea", "id": "review_text", "label": "Review Text" }
      ]
    },
    {
      "type": "mobile_slider_product",
      "name": "Mobile Drawer: Slider",
      "settings": [
        { "type": "product", "id": "product", "label": "Select Product" },
        { "type": "text", "id": "custom_badge", "label": "Badge Text (e.g. Sale)", "default": "Sale" }
      ]
    },
    {
      "type": "mobile_category",
      "name": "Mobile Drawer: Category",
      "settings": [
        { "type": "image_picker", "id": "icon", "label": "Icon Image (PNG)" },
        { "type": "text", "id": "title", "label": "Category Title" },
        { "type": "collection", "id": "collection", "label": "Link Collection (Step 2)", "info": "This populates the second step." },
        { "type": "textarea", "id": "step2_review", "label": "Step 2 Review Quote" },
        { "type": "text", "id": "step2_reviewer", "label": "Step 2 Reviewer Name" },
        { "type": "image_picker", "id": "step2_avatar", "label": "Reviewer Avatar" }
      ]
    },
    {
      "type": "mobile_footer_link",
      "name": "Mobile Drawer: Footer",
      "settings": [
        { "type": "text", "id": "title", "label": "Link Title" },
        { "type": "url", "id": "url", "label": "Link URL" }
      ]
    }
  ]
}
{% endschema %}